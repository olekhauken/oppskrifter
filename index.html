<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Oppskrifter">
<meta name="theme-color" content="#1a1a0e">
<title>Oppskrifter</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #1a1a0e;
    --bg2: #242416;
    --bg3: #2e2e1c;
    --card: #2a2a18;
    --accent: #c8a84b;
    --accent2: #e8c97a;
    --text: #f0ead6;
    --text2: #a09880;
    --danger: #c05a3a;
    --success: #5a8a4a;
    --border: rgba(200,168,75,0.2);
    --radius: 16px;
    --shadow: 0 8px 32px rgba(0,0,0,0.4);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

  /* VIEWS */
  .view { display: none; min-height: 100vh; padding-bottom: 80px; }
  .view.active { display: block; }

  /* NAV */
  nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg2); border-top: 1px solid var(--border); display: flex; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
  nav button { flex: 1; padding: 12px 8px; background: none; border: none; color: var(--text2); font-family: 'DM Sans', sans-serif; font-size: 11px; font-weight: 500; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: color 0.2s; }
  nav button.active { color: var(--accent); }
  nav button svg { width: 22px; height: 22px; }

  /* HEADER */
  .header { padding: 60px 20px 20px; background: linear-gradient(180deg, var(--bg) 0%, transparent 100%); }
  .header h1 { font-family: 'Playfair Display', serif; font-size: 32px; color: var(--accent); }
  .header p { color: var(--text2); font-size: 14px; margin-top: 4px; }

  /* SEARCH */
  .search-bar { margin: 0 20px 20px; position: relative; }
  .search-bar input { width: 100%; padding: 12px 16px 12px 44px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 15px; outline: none; }
  .search-bar input::placeholder { color: var(--text2); }
  .search-bar svg { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text2); width: 18px; height: 18px; }

  /* CATEGORY PILLS */
  .categories { display: flex; gap: 8px; padding: 0 20px 16px; overflow-x: auto; scrollbar-width: none; }
  .categories::-webkit-scrollbar { display: none; }
  .cat-pill { padding: 6px 16px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--text2); font-size: 13px; font-family: 'DM Sans', sans-serif; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
  .cat-pill.active { background: var(--accent); border-color: var(--accent); color: var(--bg); font-weight: 500; }

  /* RECIPE GRID */
  .recipe-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 20px; }
  .recipe-card { background: var(--card); border-radius: var(--radius); overflow: hidden; cursor: pointer; border: 1px solid var(--border); transition: transform 0.15s, box-shadow 0.15s; }
  .recipe-card:active { transform: scale(0.97); }
  .recipe-card .card-img { width: 100%; aspect-ratio: 1; object-fit: cover; background: var(--bg3); display: flex; align-items: center; justify-content: center; font-size: 40px; }
  .recipe-card .card-img img { width: 100%; height: 100%; object-fit: cover; }
  .recipe-card .card-body { padding: 10px 12px 12px; }
  .recipe-card .card-title { font-family: 'Playfair Display', serif; font-size: 15px; color: var(--text); line-height: 1.3; }
  .recipe-card .card-meta { font-size: 12px; color: var(--text2); margin-top: 4px; }
  .recipe-card .card-cat { display: inline-block; font-size: 11px; background: var(--bg3); color: var(--accent); padding: 2px 8px; border-radius: 10px; margin-top: 6px; }

  .empty-state { text-align: center; padding: 60px 40px; color: var(--text2); }
  .empty-state .icon { font-size: 60px; margin-bottom: 16px; }
  .empty-state h3 { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--text); margin-bottom: 8px; }

  /* FAB */
  .fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--accent); border: none; color: var(--bg); font-size: 28px; cursor: pointer; box-shadow: 0 4px 20px rgba(200,168,75,0.4); z-index: 99; display: flex; align-items: center; justify-content: center; transition: transform 0.15s; }
  .fab:active { transform: scale(0.93); }

  /* MODAL / OVERLAY */
  .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; backdrop-filter: blur(4px); }
  .overlay.active { display: block; }
  .sheet { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg2); border-radius: 24px 24px 0 0; z-index: 201; max-height: 95vh; overflow-y: auto; padding-bottom: env(safe-area-inset-bottom); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
  .sheet.active { transform: translateY(0); }
  .sheet-handle { width: 40px; height: 4px; background: var(--bg3); border-radius: 2px; margin: 12px auto 20px; }
  .sheet-title { font-family: 'Playfair Display', serif; font-size: 22px; color: var(--accent); padding: 0 20px 16px; }

  /* FORM */
  .form-group { padding: 0 20px 16px; }
  .form-group label { display: block; font-size: 12px; font-weight: 500; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
  .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px 14px; background: var(--bg3); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 15px; outline: none; }
  .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--accent); }
  .form-group textarea { min-height: 80px; resize: vertical; }
  .form-group select option { background: var(--bg2); }

  /* INGREDIENTS */
  .ingredient-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
  .ingredient-row input { flex: 1; }
  .ingredient-row input.qty { width: 70px; flex: none; }
  .ingredient-row select { width: 90px; flex: none; }
  .ingredient-row button { width: 36px; height: 36px; border-radius: 8px; border: none; background: var(--danger); color: white; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .add-ingredient-btn { width: 100%; padding: 10px; border: 1px dashed var(--border); border-radius: 10px; background: transparent; color: var(--accent); font-family: 'DM Sans', sans-serif; font-size: 14px; cursor: pointer; }

  /* STEPS */
  .step-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: flex-start; }
  .step-num { width: 28px; height: 28px; border-radius: 50%; background: var(--accent); color: var(--bg); font-size: 13px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 10px; }
  .step-row textarea { flex: 1; min-height: 60px; }
  .step-row button { width: 36px; height: 36px; border-radius: 8px; border: none; background: var(--danger); color: white; font-size: 18px; cursor: pointer; flex-shrink: 0; margin-top: 6px; }

  /* BUTTONS */
  .btn-primary { width: calc(100% - 40px); margin: 4px 20px 16px; padding: 16px; background: var(--accent); border: none; border-radius: 14px; color: var(--bg); font-family: 'DM Sans', sans-serif; font-size: 16px; font-weight: 600; cursor: pointer; }
  .btn-secondary { width: calc(100% - 40px); margin: 0 20px 12px; padding: 14px; background: transparent; border: 1px solid var(--border); border-radius: 14px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 15px; cursor: pointer; }
  .btn-danger { background: var(--danger); border-color: var(--danger); color: white; }

  /* RECIPE DETAIL */
  .detail-hero { width: 100%; aspect-ratio: 16/9; background: var(--bg3); display: flex; align-items: center; justify-content: center; font-size: 80px; overflow: hidden; }
  .detail-hero img { width: 100%; height: 100%; object-fit: cover; }
  .detail-content { padding: 20px; }
  .detail-title { font-family: 'Playfair Display', serif; font-size: 28px; color: var(--text); line-height: 1.2; }
  .detail-meta { display: flex; gap: 16px; margin: 12px 0; color: var(--text2); font-size: 13px; }
  .detail-meta span { display: flex; align-items: center; gap: 4px; }
  .detail-section { margin-top: 24px; }
  .detail-section h3 { font-family: 'Playfair Display', serif; font-size: 18px; color: var(--accent); margin-bottom: 12px; }
  .ing-list { list-style: none; }
  .ing-list li { padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 15px; display: flex; justify-content: space-between; }
  .ing-list li .ing-amount { color: var(--accent); font-weight: 500; }
  .step-list { list-style: none; counter-reset: steps; }
  .step-list li { counter-increment: steps; padding: 12px 0 12px 44px; border-bottom: 1px solid var(--border); font-size: 15px; line-height: 1.6; position: relative; }
  .step-list li::before { content: counter(steps); position: absolute; left: 0; top: 12px; width: 28px; height: 28px; background: var(--accent); color: var(--bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; }
  .detail-notes { background: var(--bg3); border-radius: 12px; padding: 14px; font-size: 14px; color: var(--text2); line-height: 1.6; margin-top: 12px; border-left: 3px solid var(--accent); }

  /* AI CAMERA VIEW */
  .ai-view { padding: 20px; }
  .camera-area { border: 2px dashed var(--border); border-radius: var(--radius); padding: 40px 20px; text-align: center; cursor: pointer; transition: border-color 0.2s; margin-bottom: 16px; }
  .camera-area:active { border-color: var(--accent); }
  .camera-area .cam-icon { font-size: 48px; margin-bottom: 12px; }
  .camera-area p { color: var(--text2); font-size: 14px; }
  .camera-area input[type=file] { display: none; }
  #preview-img { width: 100%; border-radius: var(--radius); margin-bottom: 16px; display: none; }
  .ai-result { background: var(--card); border-radius: var(--radius); padding: 16px; border: 1px solid var(--border); display: none; }
  .ai-result h3 { font-family: 'Playfair Display', serif; font-size: 18px; color: var(--accent); margin-bottom: 8px; }
  .ai-result pre { font-size: 13px; color: var(--text2); white-space: pre-wrap; line-height: 1.6; font-family: 'DM Sans', sans-serif; }
  .api-key-section { background: var(--card); border-radius: var(--radius); padding: 16px; border: 1px solid var(--border); margin-bottom: 16px; }
  .api-key-section p { font-size: 13px; color: var(--text2); margin-bottom: 10px; line-height: 1.5; }
  .api-key-section a { color: var(--accent); }

  /* SETTINGS */
  .settings-view { padding: 20px; }
  .settings-section { background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 16px; overflow: hidden; }
  .settings-row { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .settings-row:last-child { border-bottom: none; }
  .settings-row label { font-size: 14px; }
  .settings-row input { background: var(--bg3); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; flex: 1; margin-left: 12px; outline: none; }
  .settings-label { font-size: 12px; font-weight: 500; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; padding: 12px 16px 4px; }

  /* LOADING */
  .loading { display: none; text-align: center; padding: 20px; }
  .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--bg2); border: 1px solid var(--border); border-radius: 10px; padding: 10px 20px; font-size: 14px; z-index: 300; transition: transform 0.3s; white-space: nowrap; }
  .toast.show { transform: translateX(-50%) translateY(0); }

  .scale-bar { display: flex; align-items: center; gap: 12px; background: var(--bg3); border-radius: 12px; padding: 10px 14px; margin: 12px 0; }
  .scale-bar label { font-size: 13px; color: var(--text2); }
  .scale-bar input[type=range] { flex: 1; accent-color: var(--accent); }
  .scale-bar span { font-size: 14px; font-weight: 600; color: var(--accent); min-width: 30px; }
</style>
</head>
<body>

<!-- VIEW: Oppskriftsliste -->
<div class="view active" id="view-home">
  <div class="header">
    <h1>Oppskrifter</h1>
    <p id="recipe-count">0 oppskrifter</p>
  </div>
  <div class="search-bar">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
    <input type="text" id="search-input" placeholder="S√∏k etter oppskrift...">
  </div>
  <div class="categories" id="categories">
    <button class="cat-pill active" data-cat="alle">Alle</button>
    <button class="cat-pill" data-cat="Frokost">Frokost</button>
    <button class="cat-pill" data-cat="Lunsj">Lunsj</button>
    <button class="cat-pill" data-cat="Middag">Middag</button>
    <button class="cat-pill" data-cat="Dessert">Dessert</button>
    <button class="cat-pill" data-cat="Bakst">Bakst</button>
    <button class="cat-pill" data-cat="Snacks">Snacks</button>
    <button class="cat-pill" data-cat="Drikke">Drikke</button>
  </div>
  <div class="recipe-grid" id="recipe-grid"></div>
  <div class="empty-state" id="empty-state" style="display:none">
    <div class="icon">üçΩÔ∏è</div>
    <h3>Ingen oppskrifter enn√•</h3>
    <p>Trykk + for √• legge til din f√∏rste oppskrift</p>
  </div>
</div>

<!-- VIEW: Kamera / AI -->
<div class="view" id="view-camera">
  <div class="header">
    <h1>Scan oppskrift</h1>
    <p>Ta bilde eller last opp</p>
  </div>
  <div class="ai-view">
    <div class="api-key-section" id="api-key-section">
      <p>For √• lese oppskrifter fra bilde trenger du en <strong>Anthropic API-n√∏kkel</strong>.<br>
      G√• til <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> ‚Üí API Keys ‚Üí Create Key</p>
      <div class="form-group" style="padding: 0; margin-top: 8px;">
        <input type="password" id="api-key-input" placeholder="sk-ant-...">
      </div>
      <button class="btn-primary" style="margin: 8px 0 0; width: 100%;" onclick="saveApiKey()">Lagre n√∏kkel</button>
    </div>

    <!-- URL IMPORT -->
    <div style="margin-bottom: 16px;">
      <div style="font-size:12px; font-weight:500; color:var(--text2); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">Hent fra nettside</div>
      <div style="display:flex; gap:8px;">
        <input type="url" id="url-input" placeholder="https://www.matprat.no/oppskrifter/..." 
          style="flex:1; padding:12px 14px; background:var(--bg3); border:1px solid var(--border); border-radius:12px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:14px; outline:none;">
        <button onclick="analyzeUrl()" style="padding:12px 16px; background:var(--accent); border:none; border-radius:12px; color:var(--bg); font-family:'DM Sans',sans-serif; font-size:14px; font-weight:600; cursor:pointer; white-space:nowrap;">Hent</button>
      </div>
    </div>

    <div style="text-align:center; color:var(--text2); font-size:13px; margin-bottom:16px;">‚Äî eller ‚Äî</div>

    <div class="camera-area" onclick="document.getElementById('file-input').click()">
      <div class="cam-icon">üì∑</div>
      <p>Trykk for √• ta bilde eller velge fra bibliotek</p>
      <input type="file" id="file-input" accept="image/*" capture="environment" onchange="handleImage(this)">
    </div>

    <img id="preview-img" alt="Forh√•ndsvisning">

    <div class="loading" id="ai-loading">
      <div class="spinner"></div>
      <p>Leser oppskrift...</p>
    </div>

    <div class="ai-result" id="ai-result">
      <h3>Funnet oppskrift</h3>
      <pre id="ai-text"></pre>
      <button class="btn-primary" style="margin: 16px 0 0; width: 100%;" onclick="importAiRecipe()">Importer som oppskrift</button>
    </div>
  </div>
</div>

<!-- VIEW: Innstillinger -->
<div class="view" id="view-settings">
  <div class="header">
    <h1>Innstillinger</h1>
  </div>
  <div class="settings-view">
    <div class="settings-label">API</div>
    <div class="settings-section">
      <div class="settings-row">
        <label>Anthropic API-n√∏kkel</label>
        <input type="password" id="settings-api-key" placeholder="sk-ant-..." oninput="saveApiKeyFromSettings()">
      </div>
    </div>

    <div class="settings-label">Data</div>
    <div class="settings-section">
      <div class="settings-row" style="cursor:pointer" onclick="exportData()">
        <label>Eksporter alle oppskrifter</label>
        <span style="color:var(--accent)">‚Üí</span>
      </div>
      <div class="settings-row" style="cursor:pointer" onclick="document.getElementById('import-file').click()">
        <label>Importer oppskrifter</label>
        <span style="color:var(--accent)">‚Üí</span>
        <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(this)">
      </div>
      <div class="settings-row" style="cursor:pointer" onclick="clearAllData()">
        <label style="color:var(--danger)">Slett alle oppskrifter</label>
        <span style="color:var(--danger)">‚Üí</span>
      </div>
    </div>

    <div class="settings-label">Om appen</div>
    <div class="settings-section">
      <div class="settings-row"><label>Versjon</label><span style="color:var(--text2)">1.0</span></div>
      <div class="settings-row"><label>Oppskrifter lagret</label><span id="total-count" style="color:var(--text2)">0</span></div>
    </div>
  </div>
</div>

<!-- Bottom Nav -->
<nav>
  <button class="active" onclick="showView('home')" id="nav-home">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
    Hjem
  </button>
  <button onclick="showView('camera')" id="nav-camera">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
    Scan
  </button>
  <button onclick="showView('settings')" id="nav-settings">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
    Innstillinger
  </button>
</nav>

<!-- FAB -->
<button class="fab" onclick="openAddSheet()" id="fab-btn">+</button>

<!-- ADD/EDIT SHEET -->
<div class="overlay" id="overlay" onclick="closeSheet()"></div>
<div class="sheet" id="sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title" id="sheet-title">Ny oppskrift</div>

  <div class="form-group">
    <label>Navn p√• oppskrift</label>
    <input type="text" id="f-name" placeholder="F.eks. Spaghetti Carbonara">
  </div>
  <div class="form-group">
    <label>Kategori</label>
    <select id="f-cat">
      <option value="Middag">Middag</option>
      <option value="Frokost">Frokost</option>
      <option value="Lunsj">Lunsj</option>
      <option value="Dessert">Dessert</option>
      <option value="Bakst">Bakst</option>
      <option value="Snacks">Snacks</option>
      <option value="Drikke">Drikke</option>
      <option value="Annet">Annet</option>
    </select>
  </div>
  <div class="form-group" style="display:flex; gap:12px;">
    <div style="flex:1">
      <label>Porsjoner</label>
      <input type="number" id="f-portions" placeholder="4" min="1">
    </div>
    <div style="flex:1">
      <label>Tid (min)</label>
      <input type="number" id="f-time" placeholder="30" min="0">
    </div>
  </div>

  <div class="form-group">
    <label>Ingredienser</label>
    <div id="ingredients-list"></div>
    <button class="add-ingredient-btn" onclick="addIngredientRow()">+ Legg til ingrediens</button>
  </div>

  <div class="form-group">
    <label>Fremgangsm√•te</label>
    <div id="steps-list"></div>
    <button class="add-ingredient-btn" onclick="addStepRow()">+ Legg til steg</button>
  </div>

  <div class="form-group">
    <label>Notater (valgfritt)</label>
    <textarea id="f-notes" placeholder="Tips, variasjoner, allergier..."></textarea>
  </div>

  <button class="btn-primary" onclick="saveRecipe()">Lagre oppskrift</button>
  <button class="btn-secondary btn-danger" id="delete-btn" onclick="deleteRecipe()" style="display:none">Slett oppskrift</button>
  <button class="btn-secondary" onclick="closeSheet()">Avbryt</button>
  <div style="height: 20px;"></div>
</div>

<!-- DETAIL SHEET -->
<div class="overlay" id="detail-overlay" onclick="closeDetail()"></div>
<div class="sheet" id="detail-sheet">
  <div class="sheet-handle"></div>
  <div id="detail-hero" class="detail-hero">üçΩÔ∏è</div>
  <div class="detail-content">
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
      <div class="detail-title" id="d-title"></div>
      <button onclick="editCurrentRecipe()" style="background:var(--bg3); border:1px solid var(--border); color:var(--accent); padding:8px 14px; border-radius:10px; font-family:'DM Sans',sans-serif; font-size:13px; cursor:pointer;">Rediger</button>
    </div>
    <div class="detail-meta">
      <span id="d-cat"></span>
      <span id="d-time"></span>
      <span id="d-portions-display"></span>
    </div>

    <div class="scale-bar" id="scale-bar">
      <label>Porsjoner:</label>
      <input type="range" id="scale-range" min="1" max="20" value="4" oninput="updateScale(this.value)">
      <span id="scale-val">4</span>
    </div>

    <div class="detail-section" id="d-ing-section">
      <h3>Ingredienser</h3>
      <ul class="ing-list" id="d-ingredients"></ul>
    </div>
    <div class="detail-section" id="d-steps-section">
      <h3>Fremgangsm√•te</h3>
      <ol class="step-list" id="d-steps"></ol>
    </div>
    <div class="detail-section" id="d-notes-section" style="display:none">
      <h3>Notater</h3>
      <div class="detail-notes" id="d-notes"></div>
    </div>
    <div style="height:20px"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== DATA =====
const UNITS = ['ts', 'ss', 'ml', 'cl', 'dl', 'l', 'g', 'kg', 'stk', 'neve', 'klype', 'pakke', ''];
let recipes = JSON.parse(localStorage.getItem('oppskrifter') || '[]');
let currentEditId = null;
let currentDetailId = null;
let currentCat = 'alle';
let searchQuery = '';

function save() {
  localStorage.setItem('oppskrifter', JSON.stringify(recipes));
}

// ===== VIEWS =====
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  document.getElementById('nav-' + name).classList.add('active');
  const fab = document.getElementById('fab-btn');
  fab.style.display = name === 'home' ? 'flex' : 'none';
  if (name === 'home') renderGrid();
  if (name === 'settings') {
    document.getElementById('settings-api-key').value = localStorage.getItem('anthropic_key') || '';
    document.getElementById('total-count').textContent = recipes.length;
  }
}

// ===== GRID =====
function renderGrid() {
  const grid = document.getElementById('recipe-grid');
  const empty = document.getElementById('empty-state');
  const count = document.getElementById('recipe-count');

  let filtered = recipes;
  if (currentCat !== 'alle') filtered = filtered.filter(r => r.category === currentCat);
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    filtered = filtered.filter(r => r.name.toLowerCase().includes(q) ||
      (r.ingredients || []).some(i => i.name.toLowerCase().includes(q)));
  }

  count.textContent = recipes.length + ' oppskrift' + (recipes.length !== 1 ? 'er' : '');
  grid.innerHTML = '';

  if (!filtered.length) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  filtered.forEach(r => {
    const card = document.createElement('div');
    card.className = 'recipe-card';
    const imgHtml = r.image
      ? `<div class="card-img"><img src="${r.image}" alt="${r.name}"></div>`
      : `<div class="card-img">${categoryEmoji(r.category)}</div>`;
    card.innerHTML = `${imgHtml}
      <div class="card-body">
        <div class="card-title">${r.name}</div>
        <div class="card-meta">${r.time ? r.time + ' min' : ''}${r.time && r.portions ? ' ¬∑ ' : ''}${r.portions ? r.portions + ' porsjoner' : ''}</div>
        <div class="card-cat">${r.category || 'Annet'}</div>
      </div>`;
    card.onclick = () => openDetail(r.id);
    grid.appendChild(card);
  });
}

function categoryEmoji(cat) {
  const map = { Frokost: 'ü•£', Lunsj: 'ü•ó', Middag: 'üçΩÔ∏è', Dessert: 'üç∞', Bakst: 'üßÅ', Snacks: 'üçø', Drikke: '‚òï', Annet: 'üç¥' };
  return map[cat] || 'üç¥';
}

// ===== SEARCH & FILTER =====
document.getElementById('search-input').addEventListener('input', function() {
  searchQuery = this.value;
  renderGrid();
});
document.querySelectorAll('.cat-pill').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.cat-pill').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentCat = this.dataset.cat;
    renderGrid();
  });
});

// ===== ADD/EDIT SHEET =====
function openAddSheet() {
  currentEditId = null;
  document.getElementById('sheet-title').textContent = 'Ny oppskrift';
  document.getElementById('delete-btn').style.display = 'none';
  document.getElementById('f-name').value = '';
  document.getElementById('f-cat').value = 'Middag';
  document.getElementById('f-portions').value = '';
  document.getElementById('f-time').value = '';
  document.getElementById('f-notes').value = '';
  document.getElementById('ingredients-list').innerHTML = '';
  document.getElementById('steps-list').innerHTML = '';
  addIngredientRow();
  addStepRow();
  showSheet();
}

function editCurrentRecipe() {
  closeDetail();
  const r = recipes.find(x => x.id === currentDetailId);
  if (!r) return;
  currentEditId = r.id;
  document.getElementById('sheet-title').textContent = 'Rediger oppskrift';
  document.getElementById('delete-btn').style.display = 'block';
  document.getElementById('f-name').value = r.name || '';
  document.getElementById('f-cat').value = r.category || 'Middag';
  document.getElementById('f-portions').value = r.portions || '';
  document.getElementById('f-time').value = r.time || '';
  document.getElementById('f-notes').value = r.notes || '';

  const iList = document.getElementById('ingredients-list');
  iList.innerHTML = '';
  (r.ingredients || []).forEach(i => addIngredientRow(i));
  if (!r.ingredients || !r.ingredients.length) addIngredientRow();

  const sList = document.getElementById('steps-list');
  sList.innerHTML = '';
  (r.steps || []).forEach(s => addStepRow(s));
  if (!r.steps || !r.steps.length) addStepRow();

  showSheet();
}

function showSheet() {
  document.getElementById('overlay').classList.add('active');
  document.getElementById('sheet').classList.add('active');
  setTimeout(() => document.getElementById('f-name').focus(), 400);
}

function closeSheet() {
  document.getElementById('overlay').classList.remove('active');
  document.getElementById('sheet').classList.remove('active');
}

function addIngredientRow(data = {}) {
  const list = document.getElementById('ingredients-list');
  const row = document.createElement('div');
  row.className = 'ingredient-row';
  const unitOpts = UNITS.map(u => `<option value="${u}" ${u === (data.unit || '') ? 'selected' : ''}>${u || '‚Äî'}</option>`).join('');
  row.innerHTML = `
    <input class="qty" type="text" placeholder="Mengde" value="${data.amount || ''}" inputmode="decimal">
    <select>${unitOpts}</select>
    <input type="text" placeholder="Ingrediens" value="${data.name || ''}">
    <button onclick="this.parentElement.remove()">√ó</button>`;
  list.appendChild(row);
}

function addStepRow(text = '') {
  const list = document.getElementById('steps-list');
  const num = list.children.length + 1;
  const row = document.createElement('div');
  row.className = 'step-row';
  row.innerHTML = `
    <div class="step-num">${num}</div>
    <textarea placeholder="Beskriv steget...">${text}</textarea>
    <button onclick="this.parentElement.remove(); updateStepNumbers()">√ó</button>`;
  list.appendChild(row);
}

function updateStepNumbers() {
  document.querySelectorAll('#steps-list .step-num').forEach((el, i) => el.textContent = i + 1);
}

function saveRecipe() {
  const name = document.getElementById('f-name').value.trim();
  if (!name) { showToast('Skriv inn et navn!'); return; }

  const ingredients = [];
  document.querySelectorAll('#ingredients-list .ingredient-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const sel = row.querySelector('select');
    const n = inputs[1].value.trim();
    if (n) ingredients.push({ amount: inputs[0].value.trim(), unit: sel.value, name: n });
  });

  const steps = [];
  document.querySelectorAll('#steps-list textarea').forEach(ta => {
    const t = ta.value.trim();
    if (t) steps.push(t);
  });

  const recipe = {
    id: currentEditId || Date.now().toString(),
    name,
    category: document.getElementById('f-cat').value,
    portions: parseInt(document.getElementById('f-portions').value) || 4,
    time: parseInt(document.getElementById('f-time').value) || 0,
    notes: document.getElementById('f-notes').value.trim(),
    ingredients,
    steps,
    created: currentEditId ? (recipes.find(r => r.id === currentEditId)?.created || Date.now()) : Date.now()
  };

  if (currentEditId) {
    const idx = recipes.findIndex(r => r.id === currentEditId);
    recipes[idx] = recipe;
  } else {
    recipes.unshift(recipe);
  }
  save();
  closeSheet();
  renderGrid();
  showToast(currentEditId ? 'Oppskrift oppdatert!' : 'Oppskrift lagret!');
}

function deleteRecipe() {
  if (!confirm('Vil du slette denne oppskriften?')) return;
  recipes = recipes.filter(r => r.id !== currentEditId);
  save();
  closeSheet();
  renderGrid();
  showToast('Oppskrift slettet');
}

// ===== DETAIL =====
let detailRecipe = null;
let scaleMultiplier = 1;

function openDetail(id) {
  const r = recipes.find(x => x.id === id);
  if (!r) return;
  detailRecipe = r;
  currentDetailId = id;
  scaleMultiplier = 1;

  const hero = document.getElementById('detail-hero');
  if (r.image) hero.innerHTML = `<img src="${r.image}" alt="${r.name}">`;
  else hero.textContent = categoryEmoji(r.category);

  document.getElementById('d-title').textContent = r.name;
  document.getElementById('d-cat').textContent = r.category || '';
  document.getElementById('d-time').textContent = r.time ? '‚è± ' + r.time + ' min' : '';
  document.getElementById('d-portions-display').textContent = r.portions ? 'üë§ ' + r.portions + ' porsjoner' : '';

  const range = document.getElementById('scale-range');
  range.value = r.portions || 4;
  range.max = Math.max(20, (r.portions || 4) * 4);
  document.getElementById('scale-val').textContent = r.portions || 4;
  scaleMultiplier = 1;

  renderDetailIngredients(1);

  const stepsEl = document.getElementById('d-steps');
  stepsEl.innerHTML = (r.steps || []).map(s => `<li>${s}</li>`).join('');
  document.getElementById('d-steps-section').style.display = r.steps?.length ? 'block' : 'none';

  const notes = document.getElementById('d-notes');
  notes.textContent = r.notes || '';
  document.getElementById('d-notes-section').style.display = r.notes ? 'block' : 'none';

  document.getElementById('detail-overlay').classList.add('active');
  document.getElementById('detail-sheet').classList.add('active');
}

function renderDetailIngredients(multiplier) {
  const r = detailRecipe;
  if (!r) return;
  const ul = document.getElementById('d-ingredients');
  ul.innerHTML = (r.ingredients || []).map(i => {
    let amt = '';
    if (i.amount) {
      const num = parseFloat(i.amount.replace(',', '.'));
      if (!isNaN(num)) {
        const scaled = num * multiplier;
        amt = (Number.isInteger(scaled) ? scaled : Math.round(scaled * 10) / 10) + '';
      } else amt = i.amount;
    }
    return `<li><span>${i.name}</span><span class="ing-amount">${amt} ${i.unit || ''}</span></li>`;
  }).join('');
  document.getElementById('d-ing-section').style.display = r.ingredients?.length ? 'block' : 'none';
}

function updateScale(val) {
  const base = detailRecipe?.portions || 4;
  scaleMultiplier = val / base;
  document.getElementById('scale-val').textContent = val;
  renderDetailIngredients(scaleMultiplier);
}

function closeDetail() {
  document.getElementById('detail-overlay').classList.remove('active');
  document.getElementById('detail-sheet').classList.remove('active');
}

// ===== AI / CAMERA =====
let currentImageBase64 = null;
let parsedAiRecipe = null;

function saveApiKey() {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key) return;
  localStorage.setItem('anthropic_key', key);
  document.getElementById('api-key-section').innerHTML = '<p style="color:var(--success)">‚úì API-n√∏kkel lagret! Du kan n√• ta bilder av oppskrifter.</p>';
  showToast('API-n√∏kkel lagret!');
}

function saveApiKeyFromSettings() {
  const key = document.getElementById('settings-api-key').value.trim();
  localStorage.setItem('anthropic_key', key);
}

function handleImage(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const dataUrl = e.target.result;
    currentImageBase64 = dataUrl.split(',')[1];
    const prev = document.getElementById('preview-img');
    prev.src = dataUrl;
    prev.style.display = 'block';
    document.getElementById('ai-result').style.display = 'none';
    analyzeImage();
  };
  reader.readAsDataURL(file);
}

async function analyzeImage() {
  const key = localStorage.getItem('anthropic_key');
  if (!key) { showToast('Legg inn API-n√∏kkel f√∏rst!'); return; }
  if (!currentImageBase64) return;

  document.getElementById('ai-loading').style.display = 'block';
  document.getElementById('ai-result').style.display = 'none';

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': key, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({
        model: 'claude-opus-4-5',
        max_tokens: 2000,
        messages: [{
          role: 'user',
          content: [
            { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: currentImageBase64 } },
            { type: 'text', text: `Les denne oppskriften og returner den som JSON med f√∏lgende format (ingen markdown, kun ren JSON):
{"name":"","category":"Middag","portions":4,"time":30,"ingredients":[{"amount":"2","unit":"dl","name":"mel"}],"steps":["Steg 1..."],"notes":""}
Bruk norske enheter (ts, ss, ml, cl, dl, l, g, kg, stk). Kategori skal v√¶re en av: Frokost, Lunsj, Middag, Dessert, Bakst, Snacks, Drikke, Annet.` }
          ]
        }]
      })
    });
    const data = await res.json();
    const text = data.content?.[0]?.text || '';
    try {
      parsedAiRecipe = JSON.parse(text.trim());
      document.getElementById('ai-text').textContent = `‚úì Funnet: ${parsedAiRecipe.name}\n${parsedAiRecipe.ingredients?.length || 0} ingredienser\n${parsedAiRecipe.steps?.length || 0} steg`;
    } catch {
      parsedAiRecipe = null;
      document.getElementById('ai-text').textContent = text;
    }
    document.getElementById('ai-result').style.display = 'block';
  } catch (e) {
    showToast('Noe gikk galt: ' + e.message);
  }
  document.getElementById('ai-loading').style.display = 'none';
}

async function analyzeUrl() {
  const key = localStorage.getItem('anthropic_key');
  if (!key) { showToast('Legg inn API-n√∏kkel f√∏rst!'); return; }
  const url = document.getElementById('url-input').value.trim();
  if (!url) { showToast('Lim inn en URL f√∏rst!'); return; }

  document.getElementById('ai-loading').style.display = 'block';
  document.getElementById('ai-result').style.display = 'none';
  document.getElementById('preview-img').style.display = 'none';

  try {
    // Use allorigins proxy to fetch page content (bypasses CORS)
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    const proxyRes = await fetch(proxyUrl);
    const proxyData = await proxyRes.json();
    const html = proxyData.contents || '';

    // Strip HTML tags to get readable text
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    // Remove scripts and styles
    tmp.querySelectorAll('script, style, nav, footer, header, aside').forEach(el => el.remove());
    const text = tmp.innerText || tmp.textContent || '';
    // Limit to first 6000 chars to save tokens
    const trimmed = text.replace(/\s+/g, ' ').trim().slice(0, 6000);

    if (!trimmed) { showToast('Kunne ikke lese siden. Pr√∏v en annen URL.'); document.getElementById('ai-loading').style.display = 'none'; return; }

    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': key, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({
        model: 'claude-opus-4-5',
        max_tokens: 2000,
        messages: [{
          role: 'user',
          content: `Her er tekst fra en nettside med en oppskrift. Ekstraher oppskriften og returner KUN ren JSON (ingen markdown, ingen forklaring):
{"name":"","category":"Middag","portions":4,"time":30,"ingredients":[{"amount":"2","unit":"dl","name":"mel"}],"steps":["Steg 1..."],"notes":""}
Bruk norske enheter (ts, ss, ml, cl, dl, l, g, kg, stk). Kategori skal v√¶re en av: Frokost, Lunsj, Middag, Dessert, Bakst, Snacks, Drikke, Annet.

Tekst fra siden:
${trimmed}`
        }]
      })
    });
    const data = await res.json();
    const responseText = data.content?.[0]?.text || '';
    try {
      // Try to extract JSON even if there's surrounding text
      const jsonMatch = responseText.match(/\{[\s\S]*\}/);
      parsedAiRecipe = JSON.parse(jsonMatch ? jsonMatch[0] : responseText.trim());
      document.getElementById('ai-text').textContent = `‚úì Funnet: ${parsedAiRecipe.name}\n${parsedAiRecipe.ingredients?.length || 0} ingredienser\n${parsedAiRecipe.steps?.length || 0} steg`;
    } catch {
      parsedAiRecipe = null;
      document.getElementById('ai-text').textContent = responseText;
    }
    document.getElementById('ai-result').style.display = 'block';
  } catch (e) {
    showToast('Noe gikk galt: ' + e.message);
  }
  document.getElementById('ai-loading').style.display = 'none';
}

function importAiRecipe() {
  if (!parsedAiRecipe) { showToast('Ingen gyldig oppskrift funnet'); return; }
  const recipe = { ...parsedAiRecipe, id: Date.now().toString(), created: Date.now() };
  recipes.unshift(recipe);
  save();
  showToast('Oppskrift importert!');
  showView('home');
}

// ===== SETTINGS =====
function exportData() {
  const blob = new Blob([JSON.stringify(recipes, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'oppskrifter.json';
  a.click();
}

function importData(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const imported = JSON.parse(e.target.result);
      if (Array.isArray(imported)) {
        recipes = [...imported, ...recipes];
        save();
        showToast(imported.length + ' oppskrifter importert!');
        document.getElementById('total-count').textContent = recipes.length;
      }
    } catch { showToast('Ugyldig fil'); }
  };
  reader.readAsText(file);
}

function clearAllData() {
  if (!confirm('Er du sikker? Dette sletter ALLE oppskrifter permanent.')) return;
  recipes = [];
  save();
  renderGrid();
  document.getElementById('total-count').textContent = 0;
  showToast('Alle oppskrifter slettet');
}

// ===== TOAST =====
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ===== INIT =====
// Check API key on camera view
window.addEventListener('DOMContentLoaded', () => {
  const key = localStorage.getItem('anthropic_key');
  if (key) {
    document.getElementById('api-key-section').innerHTML = '<p style="color:var(--success)">‚úì API-n√∏kkel er lagret. Klar til √• skanne!</p>';
  }
  renderGrid();
});

// PWA manifest
const manifest = {
  name: 'Oppskrifter',
  short_name: 'Oppskrifter',
  start_url: '/',
  display: 'standalone',
  background_color: '#1a1a0e',
  theme_color: '#1a1a0e',
  icons: [{ src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="20" fill="%231a1a0e"/><text y=".9em" font-size="80" x="10">üçΩÔ∏è</text></svg>', sizes: 'any', type: 'image/svg+xml' }]
};
const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
const manifestUrl = URL.createObjectURL(blob);
document.querySelector('link[rel="manifest"]') || (() => {
  const link = document.createElement('link');
  link.rel = 'manifest';
  link.href = manifestUrl;
  document.head.appendChild(link);
})();
</script>
</body>
</html>
